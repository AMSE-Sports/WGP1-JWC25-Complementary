<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Complementary Ticket Registration • WGP#1</title>

  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = 'https://mhecpnqwwxspxfhdvzsc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZWNwbnF3d3hzcHhmaGR2enNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMDc0MjEsImV4cCI6MjA3ODU4MzQyMX0.ONaEMqU6BHuMSywE3Yvtbj78NqBbecI18amsD18Cgnc';

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    :root { --primary:#f37021; --border:#ececec; --ok:#16a34a; }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background:#fafafa;
      color:#111;
    }
    .header { background:#000; }
    .header img { display:block; width:100%; height:auto; }

    .container { max-width:960px; margin:0 auto; padding:16px; }
    .screen { min-height:100vh; display:flex; flex-direction:column; gap:16px; }
    .card {
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 10px 24px -18px rgba(0,0,0,.25);
    }
    .head { padding:16px; border-bottom:1px solid var(--border); }
    .body { padding:16px; }
    .row { display:grid; grid-template-columns:1fr; gap:12px; margin-bottom:12px; }
    @media (min-width:760px) { .row.two { grid-template-columns:1fr 1fr; } }

    label.title { font-weight:800; font-size:13px; margin-bottom:6px; display:block; }
    label .en { font-weight:600; color:#555; margin-left:2px; }

    input, select, textarea {
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      background:#fff;
      font-family:inherit;
      font-size:14px;
      resize:vertical;
    }
    input:focus, select:focus, textarea:focus {
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(243,112,33,.2);
    }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      border:0;
      padding:14px 20px;
      border-radius:16px;
      cursor:pointer;
    }
    .btn.primary { background:var(--primary); color:#fff; box-shadow:0 10px 24px -16px rgba(243,112,33,.85); }
    .btn.dark { background:#111; color:#fff; }
    .btn.wide { width:100%; font-size:16px; }

    .note { color:#666; font-size:12px; }
    .hidden { display:none; }

    .footer { padding:16px; text-align:center; color:#666; font-size:12px; }

    .thankfull {
      min-height:60vh;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      color:#fff;
      background:linear-gradient(135deg, #f37021, #ff8c4a);
      padding:40px 20px;
    }
    .thankfull h2 {
      font-size:40px;
      font-weight:900;
      letter-spacing:1px;
      margin-bottom:18px;
      text-shadow:0 4px 20px rgba(0,0,0,0.35);
    }
    .thankfull p {
      max-width:720px;
      font-size:18px;
      line-height:1.6;
      font-weight:500;
      text-shadow:0 2px 10px rgba(0,0,0,0.25);
    }

    .consent-desc { line-height:1.55; margin-bottom:10px; }
    label.consent-check { display:flex; gap:8px; align-items:center; }
    label.consent-check input[type="checkbox"] {
      margin-top:0;
      flex:0 0 auto;
    }
    label.consent-check span { flex:1 1 auto; }

    input[type="checkbox"], input[type="radio"] { width:auto; }
    .inline-checks { display:flex; flex-wrap:wrap; gap:8px 16px; }
    .inline-checks label { display:flex; align-items:center; gap:6px; font-size:13px; }

    .section-title {
      font-weight:800; font-size:14px; margin:8px 0;
      padding:6px 10px; border-radius:10px;
      background:#fff7f1; border:1px solid #ffe0c4;
      color:#b45309;
    }
  </style>
</head>
<body>
  <!-- Header image -->
  <div class="header">
    <img src="Header.png" alt="WGP#1 Waterjet World Cup 2025 Header">
  </div>

  <!-- SCREEN 1: FORM -->
  <section id="screen-form" class="screen container">
    <div class="card">
      <div class="head">
        <h2 style="margin:0;">Complementary Ticket Registration</h2>
        <p class="note" style="margin:4px 0 0;">
          แบบฟอร์มลงทะเบียนผู้รับบัตร Complimentary สำหรับเข้าร่วมงาน WGP#1 Waterjet World Cup 2025
        </p>
      </div>

      <form class="body" id="comp-form">
        <!-- A. Ticket Info -->
        <div class="section-title">A. Ticket Info • ข้อมูลตัวบัตร</div>

        <div class="row">
          <div>
            <label class="title">Ticket Code<span class="en"> / รหัสบัตร Complimentary</span> *</label>

            <div style="display:flex; align-items:center; gap:6px;">
              <span style="
                background:#f3f4f6;
                padding:10px 14px;
                border-radius:12px;
                border:1px solid var(--border);
                font-weight:600;
              ">25-</span>

              <input id="ticket_code_suffix"
                     type="text"
                     maxlength="5"
                     pattern="^[0-9]{5}$"
                     required
                     placeholder="กรอก 5 หลัก เช่น 00001"
                     style="flex:1;">
            </div>

            <div class="note">กรอกเฉพาะตัวเลข 5 หลักท้ายของรหัส Complimentary เช่น 00001</div>

            <!-- full ticket code 25-xxxxx -->
            <input type="hidden" id="ticket_code">
          </div>
        </div>

        <!-- B. Guest Info -->
        <div class="section-title">B. Guest Info • ข้อมูลผู้รับบัตร</div>

        <div class="row two">
          <div>
            <label class="title">คำนำหน้า<span class="en"> / Title</span> *</label>
            <select id="guest_title" required>
              <option value="">— เลือก / Select —</option>
              <option>Mr.</option>
              <option>Ms.</option>
              <option>Mrs.</option>
              <option>Dr.</option>
              <option>Prof.</option>
              <option>คุณ</option>
              <option>ดร.</option>
              <option>ศ.ดร.</option>
            </select>
          </div>
          <div>
            <label class="title">ชื่อ–นามสกุล (TH)<span class="en"> / Full Name (TH)</span> *</label>
            <input id="guest_fullname_th" required>
          </div>
        </div>

        <div class="row two">
          <div>
            <label class="title">Full Name (EN)</label>
            <input id="guest_fullname_en" placeholder="สำหรับใช้ในเอกสารภาษาอังกฤษ / if any">
          </div>
          <div>
            <label class="title">ตำแหน่ง<span class="en"> / Position</span></label>
            <input id="guest_position" placeholder="เช่น Manager, Director, Journalist">
          </div>
        </div>

        <div class="row">
          <div>
            <label class="title">บริษัท / หน่วยงาน<span class="en"> / Company / Organization</span></label>
            <input id="guest_company" placeholder="เช่น บริษัท, สื่อ, หน่วยงาน">
          </div>
        </div>

        <!-- C. Contact Info -->
        <div class="section-title">C. Contact Info • ข้อมูลติดต่อ</div>

        <div class="row two">
          <div>
            <label class="title">อีเมลสำหรับติดต่อ<span class="en"> / Contact Email</span> *</label>
            <input id="contact_email" type="email" required placeholder="name@example.com">
          </div>
          <div>
            <label class="title">เบอร์โทรศัพท์ / WhatsApp *</label>
            <input id="contact_phone" required placeholder="+66 ... / +...">
          </div>
        </div>

        <div class="row two">
          <div>
            <label class="title">ประเทศที่พำนัก<span class="en"> / Country of Residence</span> *</label>
            <select id="guest_country" required>
              <option value="">— เลือกประเทศ / Select Country —</option>
              <option value="Thailand">Thailand</option>
              <option value="Afghanistan">Afghanistan</option>
              <option value="Albania">Albania</option>
              <option value="Algeria">Algeria</option>
              <option value="Andorra">Andorra</option>
              <option value="Angola">Angola</option>
              <option value="Antigua and Barbuda">Antigua and Barbuda</option>
              <option value="Argentina">Argentina</option>
              <option value="Armenia">Armenia</option>
              <option value="Australia">Australia</option>
              <option value="Austria">Austria</option>
              <option value="Azerbaijan">Azerbaijan</option>
              <option value="Bahamas">Bahamas</option>
              <option value="Bahrain">Bahrain</option>
              <option value="Bangladesh">Bangladesh</option>
              <option value="Barbados">Barbados</option>
              <option value="Belarus">Belarus</option>
              <option value="Belgium">Belgium</option>
              <option value="Belize">Belize</option>
              <option value="Benin">Benin</option>
              <option value="Bhutan">Bhutan</option>
              <option value="Bolivia">Bolivia</option>
              <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
              <option value="Botswana">Botswana</option>
              <option value="Brazil">Brazil</option>
              <option value="Brunei">Brunei</option>
              <option value="Bulgaria">Bulgaria</option>
              <option value="Burkina Faso">Burkina Faso</option>
              <option value="Burundi">Burundi</option>
              <option value="Cambodia">Cambodia</option>
              <option value="Cameroon">Cameroon</option>
              <option value="Canada">Canada</option>
              <option value="Cape Verde">Cape Verde</option>
              <option value="Central African Republic">Central African Republic</option>
              <option value="Chad">Chad</option>
              <option value="Chile">Chile</option>
              <option value="China">China</option>
              <option value="Colombia">Colombia</option>
              <option value="Comoros">Comoros</option>
              <option value="Congo">Congo</option>
              <option value="Costa Rica">Costa Rica</option>
              <option value="Côte d’Ivoire">Côte d’Ivoire</option>
              <option value="Croatia">Croatia</option>
              <option value="Cuba">Cuba</option>
              <option value="Cyprus">Cyprus</option>
              <option value="Czechia">Czechia</option>
              <option value="Democratic Republic of the Congo">Democratic Republic of the Congo</option>
              <option value="Denmark">Denmark</option>
              <option value="Djibouti">Djibouti</option>
              <option value="Dominica">Dominica</option>
              <option value="Dominican Republic">Dominican Republic</option>
              <option value="Ecuador">Ecuador</option>
              <option value="Egypt">Egypt</option>
              <option value="El Salvador">El Salvador</option>
              <option value="Equatorial Guinea">Equatorial Guinea</option>
              <option value="Eritrea">Eritrea</option>
              <option value="Estonia">Estonia</option>
              <option value="Eswatini">Eswatini</option>
              <option value="Ethiopia">Ethiopia</option>
              <option value="Fiji">Fiji</option>
              <option value="Finland">Finland</option>
              <option value="France">France</option>
              <option value="Gabon">Gabon</option>
              <option value="Gambia">Gambia</option>
              <option value="Georgia">Georgia</option>
              <option value="Germany">Germany</option>
              <option value="Ghana">Ghana</option>
              <option value="Greece">Greece</option>
              <option value="Grenada">Grenada</option>
              <option value="Guatemala">Guatemala</option>
              <option value="Guinea">Guinea</option>
              <option value="Guinea-Bissau">Guinea-Bissau</option>
              <option value="Guyana">Guyana</option>
              <option value="Haiti">Haiti</option>
              <option value="Honduras">Honduras</option>
              <option value="Hong Kong">Hong Kong</option>
              <option value="Hungary">Hungary</option>
              <option value="Iceland">Iceland</option>
              <option value="India">India</option>
              <option value="Indonesia">Indonesia</option>
              <option value="Iran">Iran</option>
              <option value="Iraq">Iraq</option>
              <option value="Ireland">Ireland</option>
              <option value="Israel">Israel</option>
              <option value="Italy">Italy</option>
              <option value="Jamaica">Jamaica</option>
              <option value="Japan">Japan</option>
              <option value="Jordan">Jordan</option>
              <option value="Kazakhstan">Kazakhstan</option>
              <option value="Kenya">Kenya</option>
              <option value="Kiribati">Kiribati</option>
              <option value="Kuwait">Kuwait</option>
              <option value="Kyrgyzstan">Kyrgyzstan</option>
              <option value="Laos">Laos</option>
              <option value="Latvia">Latvia</option>
              <option value="Lebanon">Lebanon</option>
              <option value="Lesotho">Lesotho</option>
              <option value="Liberia">Liberia</option>
              <option value="Libya">Libya</option>
              <option value="Liechtenstein">Liechtenstein</option>
              <option value="Lithuania">Lithuania</option>
              <option value="Luxembourg">Luxembourg</option>
              <option value="Madagascar">Madagascar</option>
              <option value="Malawi">Malawi</option>
              <option value="Malaysia">Malaysia</option>
              <option value="Maldives">Maldives</option>
              <option value="Mali">Mali</option>
              <option value="Malta">Malta</option>
              <option value="Marshall Islands">Marshall Islands</option>
              <option value="Mauritania">Mauritania</option>
              <option value="Mauritius">Mauritius</option>
              <option value="Mexico">Mexico</option>
              <option value="Micronesia">Micronesia</option>
              <option value="Moldova">Moldova</option>
              <option value="Monaco">Monaco</option>
              <option value="Mongolia">Mongolia</option>
              <option value="Montenegro">Montenegro</option>
              <option value="Morocco">Morocco</option>
              <option value="Mozambique">Mozambique</option>
              <option value="Myanmar">Myanmar</option>
              <option value="Namibia">Namibia</option>
              <option value="Nauru">Nauru</option>
              <option value="Nepal">Nepal</option>
              <option value="Netherlands">Netherlands</option>
              <option value="New Zealand">New Zealand</option>
              <option value="Nicaragua">Nicaragua</option>
              <option value="Niger">Niger</option>
              <option value="Nigeria">Nigeria</option>
              <option value="North Korea">North Korea</option>
              <option value="North Macedonia">North Macedonia</option>
              <option value="Norway">Norway</option>
              <option value="Oman">Oman</option>
              <option value="Pakistan">Pakistan</option>
              <option value="Palau">Palau</option>
              <option value="Panama">Panama</option>
              <option value="Papua New Guinea">Papua New Guinea</option>
              <option value="Paraguay">Paraguay</option>
              <option value="Peru">Peru</option>
              <option value="Philippines">Philippines</option>
              <option value="Poland">Poland</option>
              <option value="Portugal">Portugal</option>
              <option value="Qatar">Qatar</option>
              <option value="Romania">Romania</option>
              <option value="Russia">Russia</option>
              <option value="Rwanda">Rwanda</option>
              <option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option>
              <option value="Saint Lucia">Saint Lucia</option>
              <option value="Saint Vincent and the Grenadines">Saint Vincent and the Grenadines</option>
              <option value="Samoa">Samoa</option>
              <option value="San Marino">San Marino</option>
              <option value="Sao Tome and Principe">Sao Tome and Principe</option>
              <option value="Saudi Arabia">Saudi Arabia</option>
              <option value="Senegal">Senegal</option>
              <option value="Serbia">Serbia</option>
              <option value="Seychelles">Seychelles</option>
              <option value="Sierra Leone">Sierra Leone</option>
              <option value="Singapore">Singapore</option>
              <option value="Slovakia">Slovakia</option>
              <option value="Slovenia">Slovenia</option>
              <option value="Solomon Islands">Solomon Islands</option>
              <option value="Somalia">Somalia</option>
              <option value="South Africa">South Africa</option>
              <option value="South Korea">South Korea</option>
              <option value="South Sudan">South Sudan</option>
              <option value="Spain">Spain</option>
              <option value="Sri Lanka">Sri Lanka</option>
              <option value="Sudan">Sudan</option>
              <option value="Suriname">Suriname</option>
              <option value="Sweden">Sweden</option>
              <option value="Switzerland">Switzerland</option>
              <option value="Syria">Syria</option>
              <option value="Taiwan">Taiwan</option>
              <option value="Tajikistan">Tajikistan</option>
              <option value="Tanzania">Tanzania</option>
              <option value="Timor-Leste">Timor-Leste</option>
              <option value="Togo">Togo</option>
              <option value="Tonga">Tonga</option>
              <option value="Trinidad and Tobago">Trinidad and Tobago</option>
              <option value="Tunisia">Tunisia</option>
              <option value="Turkey">Turkey</option>
              <option value="Turkmenistan">Turkmenistan</option>
              <option value="Tuvalu">Tuvalu</option>
              <option value="Uganda">Uganda</option>
              <option value="Ukraine">Ukraine</option>
              <option value="United Arab Emirates">United Arab Emirates</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="United States">United States</option>
              <option value="Uruguay">Uruguay</option>
              <option value="Uzbekistan">Uzbekistan</option>
              <option value="Vanuatu">Vanuatu</option>
              <option value="Venezuela">Venezuela</option>
              <option value="Vietnam">Vietnam</option>
              <option value="Yemen">Yemen</option>
              <option value="Zambia">Zambia</option>
              <option value="Zimbabwe">Zimbabwe</option>
            </select>
          </div>
          <div>
            <label class="title">เมือง / จังหวัด<span class="en"> / City</span> *</label>
            <input id="guest_city" required pattern="[\u0E00-\u0E7F a-zA-Z\- ]+" placeholder="เช่น Bangkok / Pattaya">
            <div class="note">รองรับอักษรไทย/อังกฤษและช่องว่างเท่านั้น • Thai/English letters & spaces only</div>
          </div>
        </div>

        <!-- D. Attendance -->
        <div class="section-title">D. Attendance Info • วันที่เข้าร่วมงาน</div>

        <div class="row">
          <div>
            <label class="title">เลือกวันที่จะเข้าร่วม<span class="en"> / Which day(s) will you attend?</span> *</label>
            <div class="inline-checks" id="attend_days_group">
              <label><input type="checkbox" value="Wed 17 Dec"> <span>Wed 17 Dec</span></label>
              <label><input type="checkbox" value="Thu 18 Dec"> <span>Thu 18 Dec</span></label>
              <label><input type="checkbox" value="Fri 19 Dec"> <span>Fri 19 Dec</span></label>
              <label><input type="checkbox" value="Sat 20 Dec"> <span>Sat 20 Dec</span></label>
              <label><input type="checkbox" value="Sun 21 Dec"> <span>Sun 21 Dec</span></label>
            </div>
            <div class="note">กรุณาเลือกอย่างน้อย 1 วัน • Please select at least one day.</div>
          </div>
        </div>

        <!-- E. Consent -->
        <div class="section-title">E. PDPA & Media Consent</div>

        <div class="row">
          <div>
            <label class="title">การจัดเก็บและใช้ข้อมูลส่วนบุคคล<span class="en"> / PDPA Consent</span> *</label>
            <div class="consent-desc">
              ข้อมูลที่กรอกในแบบฟอร์มนี้จะถูกใช้เพื่อการจัดการงาน ที่นั่ง พิธีการ และการติดต่อประสานงานเกี่ยวกับงาน WGP#1 Waterjet World Cup 2025 เท่านั้น และจะไม่ถูกนำไปใช้เพื่อวัตถุประสงค์อื่นโดยไม่ได้รับความยินยอม
            </div>
            <label class="consent-check">
              <input type="checkbox" id="pdpa_consent" required>
              <span>ฉันได้อ่านและยินยอมให้จัดเก็บและใช้ข้อมูลส่วนบุคคลตามที่ระบุไว้ข้างต้น • I have read and consent to the use of my personal data as stated above.</span>
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <label class="title">การบันทึกภาพและวิดีโอ<span class="en"> / Media (Photo & Video) Consent</span> *</label>
            <div class="consent-desc">
              <strong>EN:</strong> By attending the WGP#1 Waterjet World Cup 2025, which includes live broadcasting and global media coverage, you grant the event organizers and their partners the right to photograph, film, and record your image and voice for use in promotions, advertising, live streams, and other media—without the need for further consent or compensation. Entering the event area constitutes full and unconditional consent. If you do not wish to appear in such media, please avoid camera zones or broadcast areas.
              <br><br>
              <strong>TH:</strong> ในการเข้าชมการแข่งขัน WGP#1 Waterjet World Cup 2025 ซึ่งมีการถ่ายทอดสดและเผยแพร่สู่สาธารณะทั่วโลก ท่านยินยอมให้ผู้จัดงานและพันธมิตร สามารถบันทึกภาพนิ่ง วิดีโอ และเสียงของท่าน เพื่อใช้ในสื่อประชาสัมพันธ์ โฆษณา ถ่ายทอดสด และสื่ออื่น ๆ โดยไม่ต้องขออนุญาตหรือจ่ายค่าตอบแทนใด ๆ เพิ่มเติม การเข้าสู่พื้นที่จัดงาน ถือเป็นการให้ความยินยอมโดยสมบูรณ์ หากไม่ประสงค์ให้ถูกบันทึกภาพ โปรดหลีกเลี่ยงบริเวณกล้องหรือพื้นที่ถ่ายทอดสด
            </div>
            <label class="consent-check">
              <input type="checkbox" id="media_consent" required>
              <span>ฉันได้อ่านและยินยอมตามเงื่อนไขการบันทึกภาพและวิดีโอข้างต้น • I have read and consent to the media conditions above.</span>
            </label>
          </div>
        </div>

        <button class="btn primary wide" type="submit" id="submit-btn">
          ยืนยันรับบัตร Complimentary • Submit Complimentary Ticket Form
        </button>
      </form>
    </div>

    <div class="footer">© 2025 WGP#1 • Complementary Ticket Registration</div>
  </section>

  <!-- SCREEN 2: THANK YOU -->
  <section id="screen-thank" class="screen container hidden">
    <div class="card">
      <div class="thankfull">
        <h2>THANK YOU!</h2>
        <p>
          Thank you for being part of this world-class competition — we hope you enjoy an unforgettable and thrilling experience!<br><br>
          ขอบคุณที่ร่วมเป็นส่วนหนึ่งของการแข่งขันระดับโลกครั้งนี้ — ขอให้คุณสนุกกับประสบการณ์สุดมันส์!
        </p>
      </div>
      <div class="body" style="text-align:center">
        <button class="btn dark" id="back-to-form">
          กรอกแบบฟอร์มสำหรับบัตรใบถัดไป • New Entry
        </button>
      </div>
    </div>
  </section>

  <script>
    function showScreen(id) {
      document.getElementById('screen-form').classList.add('hidden');
      document.getElementById('screen-thank').classList.add('hidden');
      document.getElementById(id).classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ประกอบ Ticket Code = 25-xxxxx จาก suffix
    (function initTicketCode() {
      const suffixInput = document.getElementById('ticket_code_suffix');
      const fullCodeHidden = document.getElementById('ticket_code');

      suffixInput.addEventListener('input', function () {
        // ให้เป็นตัวเลขเท่านั้น
        this.value = this.value.replace(/[^0-9]/g, '');

        // จำกัดความยาว 5 หลัก
        if (this.value.length > 5) {
          this.value = this.value.slice(0, 5);
        }

        // ถ้าครบ 5 หลักค่อยเซ็ต ticket_code เต็ม
        if (this.value.length === 5) {
          fullCodeHidden.value = '25-' + this.value;
        } else {
          fullCodeHidden.value = '';
        }
      });
    })();

    // Submit -> Supabase insert
    document.getElementById('comp-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      // ==== ตรวจสอบ Ticket Code (5 หลัก + ประกอบรหัส) ====
      const suffixInput = document.getElementById('ticket_code_suffix');
      const fullCodeHidden = document.getElementById('ticket_code');
      const ticketSuffix = (suffixInput.value || '').trim();

      if (!/^[0-9]{5}$/.test(ticketSuffix)) {
        alert('กรุณากรอกเลข 5 หลักท้ายของรหัสบัตร (เฉพาะตัวเลข 0–9) เช่น 00001');
        suffixInput.focus();
        return;
      }

      const ticketCode = '25-' + ticketSuffix;
      fullCodeHidden.value = ticketCode;

      // ==== ตรวจอย่างน้อย 1 วัน ====
      var dayChecks = document.querySelectorAll('#attend_days_group input[type=checkbox]');
      var selectedDays = [];
      dayChecks.forEach(function (ch) {
        if (ch.checked) selectedDays.push(ch.value);
      });
      if (selectedDays.length === 0) {
        alert('กรุณาเลือกวันที่จะเข้าร่วมอย่างน้อย 1 วัน / Please select at least one day.');
        return;
      }

      // ==== เช็คเลขซ้ำบน Supabase ====
      try {
        const { error: dupError, count } = await sb
          .from('complementary_tickets')   // ให้ตรงกับชื่อตารางใน Supabase
          .select('id', { count: 'exact', head: true })
          .eq('ticket_code', ticketCode);

        if (dupError) {
          console.error('Duplicate check error:', dupError);
          alert('ไม่สามารถตรวจสอบรหัสบัตรได้ในขณะนี้ กรุณาลองใหม่อีกครั้ง หรือแจ้งเจ้าหน้าที่');
          return;
        }

        if (count && count > 0) {
          alert('รหัสบัตร ' + ticketCode + ' ถูกใช้ไปแล้ว กรุณาใช้หมายเลขอื่น');
          return;
        }
      } catch (err) {
        console.error('Unexpected duplicate check error:', err);
        alert('เกิดข้อผิดพลาดในการตรวจสอบรหัสบัตร กรุณาลองใหม่อีกครั้ง');
        return;
      }

      var btn = document.getElementById('submit-btn');
      var oldText = btn.textContent;
      btn.textContent = 'กำลังส่ง... / Submitting...';
      btn.disabled = true;

      var payload = {
        submitted_at: new Date().toISOString(),

        ticket_code: ticketCode,

        guest_title: document.getElementById('guest_title').value || null,
        guest_fullname_th: document.getElementById('guest_fullname_th').value.trim() || null,
        guest_fullname_en: document.getElementById('guest_fullname_en').value.trim() || null,
        guest_position: document.getElementById('guest_position').value.trim() || null,
        guest_company: document.getElementById('guest_company').value.trim() || null,

        contact_email: document.getElementById('contact_email').value.trim() || null,
        contact_phone: document.getElementById('contact_phone').value.trim() || null,
        guest_country: document.getElementById('guest_country').value || null,
        guest_city: document.getElementById('guest_city').value.trim() || null,

        attend_days: selectedDays.join(', '),

        pdpa_consent: document.getElementById('pdpa_consent').checked,
        media_consent: document.getElementById('media_consent').checked
      };

      try {
        const { error } = await sb
          .from('complementary_tickets')
          .insert([payload]);

        if (error) {
          console.error('Supabase insert error:', error);

          // ถ้าเจอ unique violation เผื่อกรณี race condition/กดซ้ำ
          if (error.code === '23505') {
            alert('รหัสบัตร ' + ticketCode + ' ถูกใช้ไปแล้วในระบบ กรุณาใช้หมายเลขอื่นหรือรีเช็กกับเจ้าหน้าที่');
          } else {
            alert('บันทึกข้อมูลไม่สำเร็จ กรุณาลองอีกครั้ง หรือแจ้งเจ้าหน้าที่\n\nError: ' + error.message);
          }
        } else {
          document.getElementById('comp-form').reset();
          showScreen('screen-thank');
        }
      } catch (err) {
        console.error('Unexpected error:', err);
        alert('เกิดข้อผิดพลาดในการเชื่อมต่อระบบ กรุณาลองใหม่อีกครั้ง');
      } finally {
        btn.textContent = oldText;
        btn.disabled = false;
      }
    });

    document.getElementById('back-to-form').addEventListener('click', function () {
      showScreen('screen-form');
    });
  </script>
</body>
</html>
