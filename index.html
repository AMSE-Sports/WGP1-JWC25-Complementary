<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Complementary Ticket Registration • WGP#1</title>

  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = 'https://mhecpnqwwxspxfhdvzsc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZWNwbnF3d3hzcHhmaGR2enNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMDc0MjEsImV4cCI6MjA3ODU4MzQyMX0.ONaEMqU6BHuMSywE3Yvtbj78NqBbecI18amsD18Cgnc';

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    :root {
      --primary:#f37021;
      --border:#ececec;
      --ok:#16a34a;

      /* +30% */
      --font-base:    clamp(19px, 2.1vw, 23px);
      --font-label:   clamp(18px, 1.8vw, 22px);
      --font-title:   clamp(26px, 3.1vw, 36px);
      --font-section: clamp(19px, 2.1vw, 25px);
      --font-note:    clamp(14px, 1.6vw, 18px);
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background:#fafafa;
      color:#111;
      font-size:var(--font-base);
      width:100%;
      min-height:100vh;
    }

    .header { background:#000; }
    .header img { display:block; width:100%; height:auto; }

    .container {
      width:100%;
      max-width:none;
      margin:0;
      padding:0;
    }

    .screen {
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .card {
      width:100%;
      background:#fff;
      border-radius:0;
      border:0;
      box-shadow:none;
    }

    .head {
      padding:24px 20px;
      border-bottom:1px solid var(--border);
    }
    .head h2 {
      margin:0;
      font-size:var(--font-title);
      font-weight:900;
    }
    .head .note {
      margin-top:6px;
    }

    .body { padding:24px 20px; }

    .row {
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
      margin-bottom:16px;
    }
    @media (min-width:760px) {
      .row.two { grid-template-columns:1fr 1fr; }
    }

    label.title {
      font-weight:800;
      font-size:var(--font-label);
      margin-bottom:6px;
      display:block;
    }
    label .en {
      font-weight:600;
      color:#555;
      margin-left:2px;
      font-size:calc(var(--font-label) - 1px);
    }

    input, select, textarea {
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--border);
      outline:none;
      background:#fff;
      font-family:inherit;
      font-size:var(--font-base);
      resize:vertical;
    }
    input:focus, select:focus, textarea:focus {
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(243,112,33,.2);
    }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      border:0;
      padding:18px 24px;
      border-radius:16px;
      cursor:pointer;
      font-size:var(--font-base);
    }
    .btn.primary {
      background:var(--primary);
      color:#fff;
      box-shadow:0 10px 24px -16px rgba(243,112,33,.85);
    }
    .btn.dark { background:#111; color:#fff; }
    .btn.wide { width:100%; }

    .note {
      color:#666;
      font-size:var(--font-note);
    }

    .hidden {
      display:none !important;
    }

    .footer {
      padding:12px 16px;
      text-align:center;
      color:#666;
      font-size:var(--font-note);
    }

    .thankfull {
      min-height:70vh;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      color:#fff;
      background:linear-gradient(135deg, #f37021, #ff8c4a);
      padding:40px 20px;
    }
    .thankfull h2 {
      font-size:clamp(32px, 5vw, 60px);
      font-weight:900;
      letter-spacing:1px;
      margin-bottom:18px;
      text-shadow:0 4px 20px rgba(0,0,0,0.35);
    }
    .thankfull p {
      max-width:720px;
      font-size:clamp(16px, 2vw, 22px);
      line-height:1.6;
      font-weight:500;
      text-shadow:0 2px 10px rgba(0,0,0,0.25);
      margin:0;
    }

    .consent-desc {
      line-height:1.55;
      margin-bottom:10px;
      font-size:var(--font-base);
    }

    /* Checkbox consent */
    label.consent-check {
      display:flex;
      gap:16px;
      align-items:center;
      font-size:var(--font-base);
    }
    .consent-check input[type="checkbox"] {
      width:32px;
      height:32px;
      accent-color:var(--primary);
      flex:0 0 auto;
    }
    .consent-text {
      display:flex;
      flex-direction:column;
      line-height:1.35;
      font-size:var(--font-base);
    }

    /* Attendance days inline */
    .inline-checks {
      display:flex;
      flex-wrap:wrap;
      gap:18px 30px;
    }
    .inline-checks label {
      display:flex;
      align-items:center;
      gap:10px;
      font-size:calc(var(--font-base) * 0.95);
      white-space:nowrap;
    }
    .inline-checks input[type="checkbox"] {
      width:22px;
      height:22px;
      accent-color:var(--primary);
    }

    .section-title {
      font-weight:900;
      font-size:var(--font-section);
      margin:12px 0;
      padding:10px 14px;
      border-radius:14px;
      background:#fff7f1;
      border:1px solid #ffe0c4;
      color:#b45309;
    }
  </style>
</head>
<body>
  <!-- Header image -->
  <div class="header">
    <img src="Header.png" alt="WGP#1 Waterjet World Cup 2025 Header">
  </div>

  <!-- SCREEN 1: FORM -->
  <section id="screen-form" class="screen container">
    <div class="card">
      <div class="head">
        <h2 style="margin:0;">Complementary Ticket Registration</h2>
        <p class="note" style="margin:4px 0 0;">
          แบบฟอร์มลงทะเบียนผู้รับบัตร Complimentary สำหรับเข้าร่วมงาน WGP#1 Waterjet World Cup 2025
        </p>
      </div>

      <form class="body" id="comp-form">
        <!-- A. Ticket Info -->
        <div class="section-title">A. Ticket Info • ข้อมูลตัวบัตร</div>

        <div class="row">
          <div>
            <label class="title">Ticket Code<span class="en"> / รหัสบัตร Complimentary</span> *</label>

            <div style="display:flex; align-items:center; gap:6px;">
              <span style="
                background:#f3f4f6;
                padding:10px 14px;
                border-radius:12px;
                border:1px solid var(--border);
                font-weight:600;
              ">25-</span>

              <input id="ticket_code_suffix"
                     type="text"
                     maxlength="5"
                     pattern="^[0-9]{5}$"
                     required
                     placeholder="กรอก 5 หลัก เช่น 00001"
                     style="flex:1;">
            </div>

            <div class="note">กรอกเฉพาะตัวเลข 5 หลักท้ายของรหัส Complimentary เช่น 00001</div>
            <input type="hidden" id="ticket_code">
          </div>
        </div>

        <!-- B. Guest Info -->
        <div class="section-title">B. Guest Info • ข้อมูลผู้รับบัตร</div>

        <div class="row two">
          <div>
            <label class="title">ชื่อจริง (TH/EN)<span class="en"> / First Name (TH/EN)</span> *</label>
            <input id="guest_firstname_th" required>
          </div>
          <div>
            <label class="title">นามสกุล (TH/EN)<span class="en"> / Last Name (TH/EN)</span> *</label>
            <input id="guest_lastname_th" required>
          </div>
        </div>

        <div class="note" style="margin-top:-8px; margin-bottom:16px;">
          กรุณากรอกชื่อ–นามสกุลตามบัตรประชาชนหรือหนังสือเดินทาง • Please use your legal first and last name.
        </div>

        <!-- เพศ + ช่วงอายุ -->
        <div class="row two">
          <div>
            <label class="title">เพศ<span class="en"> / Gender</span> *</label>
            <select id="guest_gender" required>
              <option value="">— เลือกเพศ / Select —</option>
              <option value="Male">ชาย / Male</option>
              <option value="Female">หญิง / Female</option>
              <option value="Other">ไม่ระบุ / Other</option>
            </select>
          </div>
          <div>
            <label class="title">อายุ<span class="en"> / Age Range</span> *</label>
            <select id="guest_age_range" required>
              <option value="">— เลือกช่วงอายุ / Select —</option>
              <option value="Under 18">ต่ำกว่า 18 ปี / Under 18</option>
              <option value="18-25">18–25 ปี / 18–25</option>
              <option value="26-40">26–40 ปี / 26–40</option>
              <option value="41-60">41–60 ปี / 41–60</option>
              <option value="60+">60 ปีขึ้นไป / 60+</option>
            </select>
          </div>
        </div>

        <!-- C. Contact Info -->
        <div class="section-title">C. Contact Info • ข้อมูลติดต่อ</div>

        <div class="row two">
          <div>
            <label class="title">เบอร์โทรศัพท์ / Phone No. *</label>
            <input id="contact_phone" required placeholder="+66 ... / +...">
          </div>
          <div>
            <label class="title">ประเทศที่พำนัก<span class="en"> / Country of Residence</span> *</label>
            <select id="guest_country" required>
              <option value="">— เลือกประเทศ / Select Country —</option>
              <!-- รายชื่อประเทศ ตามเดิม (ตัดไม่ให้ยาวเกินในตัวอย่าง) -->
              <option value="Thailand">Thailand</option>
              <option value="Australia">Australia</option>
              <option value="Japan">Japan</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="United States">United States</option>
              <!-- … ที่เหลือคงไว้ตามโค้ดเดิมของคุณ … -->
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label class="title">เมือง / จังหวัด<span class="en"> / City</span> *</label>
            <input id="guest_city" required
                   pattern="[\u0E00-\u0E7F a-zA-Z\- ]+"
                   placeholder="เช่น Bangkok / Pattaya">
            <div class="note">
              รองรับอักษรไทย/อังกฤษและช่องว่างเท่านั้น • Thai/English letters & spaces only
            </div>
          </div>
        </div>

        <!-- D. Attendance -->
        <div class="section-title">D. Attendance Info • วันที่เข้าร่วมงาน</div>

        <div class="row">
          <div>
            <label class="title">เลือกวันที่จะเข้าร่วม<span class="en"> / Which day(s) will you attend?</span> *</label>
            <div class="inline-checks" id="attend_days_group">
              <label><input type="checkbox" value="Wed 17 Dec"> <span>Wed 17 Dec</span></label>
              <label><input type="checkbox" value="Thu 18 Dec"> <span>Thu 18 Dec</span></label>
              <label><input type="checkbox" value="Fri 19 Dec"> <span>Fri 19 Dec</span></label>
              <label><input type="checkbox" value="Sat 20 Dec"> <span>Sat 20 Dec</span></label>
              <label><input type="checkbox" value="Sun 21 Dec"> <span>Sun 21 Dec</span></label>
            </div>
            <div class="note">กรุณาเลือกอย่างน้อย 1 วัน • Please select at least one day.</div>
          </div>
        </div>

        <!-- E. Consent -->
        <div class="section-title">E. Media & Personal Data • ข้อกำหนดสื่อและข้อมูลส่วนบุคคล</div>

        <div class="row">
          <div>
            <label class="title">
              ข้อกำหนดเกี่ยวกับสื่อภาพ/วิดีโอและข้อมูลส่วนบุคคล
              <span class="en">/ Media & Personal Data Conditions</span> *
            </label>

            <div class="consent-desc">
              <strong>TH: ข้อมูลส่วนบุคคล</strong><br>
              ข้อมูลที่กรอกในแบบฟอร์มนี้จะถูกใช้เพื่อการจัดการงาน ที่นั่ง พิธีการ และการติดต่อประสานงานเกี่ยวกับงาน
              WGP#1 Waterjet World Cup 2025 เท่านั้น และจะไม่ถูกนำไปใช้เพื่อวัตถุประสงค์อื่นโดยไม่ได้รับความยินยอม
              <br><br>
              <strong>EN: Personal Data (PDPA)</strong><br>
              The personal data you provide in this form will be used only for event management, seating, protocol,
              and coordination related to the WGP#1 Waterjet World Cup 2025. It will not be used for any other
              purposes without your further consent.
              <br><br>
              <strong>EN: Media (Photo & Video)</strong><br>
              By attending the WGP#1 Waterjet World Cup 2025, which includes live broadcasting and global media coverage,
              you grant the event organizers and their partners the right to photograph, film, and record your image and voice
              for use in promotions, advertising, live streams, and other media—without the need for further consent or compensation.
              Entering the event area constitutes full and unconditional consent. If you do not wish to appear in such media,
              please avoid camera zones or broadcast areas.
              <br><br>
              <strong>TH: การบันทึกภาพและวิดีโอ</strong><br>
              ในการเข้าชมการแข่งขัน WGP#1 Waterjet World Cup 2025 ซึ่งมีการถ่ายทอดสดและเผยแพร่สู่สาธารณะทั่วโลก
              ท่านยินยอมให้ผู้จัดงานและพันธมิตร สามารถบันทึกภาพนิ่ง วิดีโอ และเสียงของท่าน เพื่อใช้ในสื่อประชาสัมพันธ์
              โฆษณา ถ่ายทอดสด และสื่ออื่น ๆ โดยไม่ต้องขออนุญาตหรือจ่ายค่าตอบแทนใด ๆ เพิ่มเติม
              การเข้าสู่พื้นที่จัดงาน ถือเป็นการให้ความยินยอมโดยสมบูรณ์ หากไม่ประสงค์ให้ถูกบันทึกภาพ
              โปรดหลีกเลี่ยงบริเวณกล้องหรือพื้นที่ถ่ายทอดสด
            </div>

            <label class="consent-check">
              <input type="checkbox" id="media_consent" required>
              <span class="consent-text">
                <span>ฉันได้อ่านและยินยอมตามข้อกำหนดข้างต้นทั้งหมด</span>
                <span>I have read and consent to all conditions above.</span>
              </span>
            </label>
          </div>
        </div>

        <button class="btn primary wide" type="submit" id="submit-btn">
          ยืนยันรับบัตร Complimentary • Submit Complimentary Ticket Form
        </button>
      </form>
    </div>

    <div class="footer">© 2025 WGP#1 • Complementary Ticket Registration</div>
  </section>

  <!-- SCREEN 2: THANK YOU -->
  <section id="screen-thank" class="screen container hidden">
    <div class="card">
      <div class="thankfull">
        <h2>THANK YOU!</h2>
        <p>
          Thank you for being part of this world-class competition — we hope you enjoy an unforgettable and thrilling experience!<br><br>
          ขอบคุณที่ร่วมเป็นส่วนหนึ่งของการแข่งขันระดับโลกครั้งนี้ — ขอให้คุณสนุกกับประสบการณ์สุดมันส์!
        </p>
      </div>
      <div class="body" style="text-align:center">
        <button class="btn dark" id="back-to-form">
          กรอกแบบฟอร์มสำหรับบัตรใบถัดไป • New Entry
        </button>
      </div>
    </div>
  </section>

  <script>
    function showScreen(id) {
      document.getElementById('screen-form').classList.add('hidden');
      document.getElementById('screen-thank').classList.add('hidden');
      document.getElementById(id).classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ประกอบ Ticket Code = 25-xxxxx จาก suffix
    (function initTicketCode() {
      const suffixInput = document.getElementById('ticket_code_suffix');
      const fullCodeHidden = document.getElementById('ticket_code');

      suffixInput.addEventListener('input', function () {
        this.value = this.value.replace(/[^0-9]/g, '');
        if (this.value.length > 5) {
          this.value = this.value.slice(0, 5);
        }
        if (this.value.length === 5) {
          fullCodeHidden.value = '25-' + this.value;
        } else {
          fullCodeHidden.value = '';
        }
      });
    })();

    // Submit -> Supabase insert
    document.getElementById('comp-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      // ==== ตรวจสอบ Ticket Code (5 หลัก) ====
      const suffixInput = document.getElementById('ticket_code_suffix');
      const ticketSuffix = (suffixInput.value || '').trim();

      if (!/^[0-9]{5}$/.test(ticketSuffix)) {
        alert('กรุณากรอกเลข 5 หลักท้ายของรหัสบัตร (เฉพาะตัวเลข 0–9) เช่น 00001');
        suffixInput.focus();
        return;
      }

      const ticketCode = '25-' + ticketSuffix;
      document.getElementById('ticket_code').value = ticketCode;

      // ==== ตรวจชื่อ ====
      const firstNameTh = document.getElementById('guest_firstname_th').value.trim();
      const lastNameTh  = document.getElementById('guest_lastname_th').value.trim();

      if (!firstNameTh || !lastNameTh) {
        alert('กรุณากรอกชื่อจริงและนามสกุลให้ครบถ้วน');
        return;
      }
      const guestFullnameTh = firstNameTh + ' ' + lastNameTh;

      // ==== ตรวจอย่างน้อย 1 วัน ====
      const dayChecks = document.querySelectorAll('#attend_days_group input[type=checkbox]');
      const selectedDays = [];
      dayChecks.forEach(ch => { if (ch.checked) selectedDays.push(ch.value); });
      if (selectedDays.length === 0) {
        alert('กรุณาเลือกวันที่จะเข้าร่วมอย่างน้อย 1 วัน / Please select at least one day.');
        return;
      }

      // ==== เช็คเลขซ้ำบน Supabase ====
      try {
        const { error: dupError, count } = await sb
          .from('complementary_tickets')
          .select('id', { count: 'exact', head: true })
          .eq('ticket_code', ticketCode);

        if (dupError) {
          console.error('Duplicate check error:', dupError);
          alert('ไม่สามารถตรวจสอบรหัสบัตรได้ในขณะนี้ กรุณาลองใหม่อีกครั้ง หรือแจ้งเจ้าหน้าที่');
          return;
        }

        if (count && count > 0) {
          alert('รหัสบัตร ' + ticketCode + ' ถูกใช้ไปแล้ว กรุณาใช้หมายเลขอื่น');
          return;
        }
      } catch (err) {
        console.error('Unexpected duplicate check error:', err);
        alert('เกิดข้อผิดพลาดในการตรวจสอบรหัสบัตร กรุณาลองใหม่อีกครั้ง');
        return;
      }

      const btn = document.getElementById('submit-btn');
      const oldText = btn.textContent;
      btn.textContent = 'กำลังส่ง... / Submitting...';
      btn.disabled = true;

      const payload = {
        submitted_at: new Date().toISOString(),

        ticket_code: ticketCode,

        guest_title: null,
        guest_fullname_th: guestFullnameTh,
        guest_fullname_en: null,
        guest_position: null,
        guest_company: null,

        guest_gender: document.getElementById('guest_gender').value || null,
        guest_age_range: document.getElementById('guest_age_range').value || null,

        contact_email: null,
        contact_phone: document.getElementById('contact_phone').value.trim() || null,
        guest_country: document.getElementById('guest_country').value || null,
        guest_city: document.getElementById('guest_city').value.trim() || null,

        attend_days: selectedDays.join(', '),

        media_consent: document.getElementById('media_consent').checked
      };

      try {
        const { error } = await sb
          .from('complementary_tickets')
          .insert([payload]);

        if (error) {
          console.error('Supabase insert error:', error);

          if (error.code === '23505') {
            alert('รหัสบัตร ' + ticketCode + ' ถูกใช้ไปแล้วในระบบ กรุณาใช้หมายเลขอื่นหรือรีเช็กกับเจ้าหน้าที่');
          } else {
            alert('บันทึกข้อมูลไม่สำเร็จ กรุณาลองอีกครั้ง หรือแจ้งเจ้าหน้าที่\n\nError: ' + error.message);
          }
        } else {
          document.getElementById('comp-form').reset();
          showScreen('screen-thank');
        }
      } catch (err) {
        console.error('Unexpected error:', err);
        alert('เกิดข้อผิดพลาดในการเชื่อมต่อระบบ กรุณาลองใหม่อีกครั้ง');
      } finally {
        btn.textContent = oldText;
        btn.disabled = false;
      }
    });

    document.getElementById('back-to-form').addEventListener('click', function () {
      showScreen('screen-form');
    });
  </script>
</body>
</html>
